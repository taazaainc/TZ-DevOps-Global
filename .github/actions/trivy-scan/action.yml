name: Trivy Container Image Security Scan
description: >
  Scans a pre-built Docker image for vulnerabilities using Trivy.
  Uploads a JSON report as a workflow artifact.
  Set fail-on-critical to 'true' to make CRITICAL vulnerabilities block the pipeline.

inputs:
  image-name:
    description: Full image name including tag (e.g. myregistry.example.com/myproject/myservice:test-42)
    required: true
  service-name:
    description: Service name used for artifact naming
    required: true
  severity:
    description: Comma-separated severity levels to scan
    required: false
    default: "CRITICAL,HIGH,MEDIUM"
  fail-on-critical:
    description: Set to 'true' to fail the pipeline when CRITICAL vulnerabilities are found
    required: false
    default: "false"
  trivy-image:
    description: >
      Trivy Docker image to use for scanning.
      Use a private registry mirror to avoid Docker Hub rate limits.
      Example: myregistry.example.com/devops-shared/trivy:latest
      Falls back to aquasec/trivy:latest from Docker Hub if not provided.
    required: false
    default: "aquasec/trivy:latest"
  registry:
    description: >
      Container registry hostname to login to before pulling trivy image.
      Only used when registry-username and registry-password are provided.
    required: false
    default: ""
  registry-username:
    description: Username for the container registry (to pull trivy image)
    required: false
    default: ""
  registry-password:
    description: Password for the container registry (to pull trivy image)
    required: false
    default: ""

outputs:
  critical-count:
    description: Number of CRITICAL vulnerabilities found
    value: ${{ steps.scan.outputs.critical_count }}
  high-count:
    description: Number of HIGH vulnerabilities found
    value: ${{ steps.scan.outputs.high_count }}

runs:
  using: composite
  steps:
    - name: Login to container registry
      shell: bash
      run: |
        if [ -n "${{ inputs.registry-username }}" ] && [ -n "${{ inputs.registry-password }}" ]; then
          # Derive registry hostname from trivy-image if registry input is not explicitly set
          REGISTRY="${{ inputs.registry }}"
          if [ -z "$REGISTRY" ]; then
            REGISTRY=$(echo "${{ inputs.trivy-image }}" | cut -d'/' -f1)
          fi
          echo "${{ inputs.registry-password }}" | docker login "$REGISTRY" -u "${{ inputs.registry-username }}" --password-stdin
          echo "Logged in to $REGISTRY"
        else
          echo "No registry credentials provided â€” skipping login (using cached auth or Docker Hub)"
        fi

    - name: Trivy Security Scan
      id: scan
      shell: bash
      run: |
        SERVICE_NAME_SAFE=$(echo "${{ inputs.service-name }}" | tr ' ' '-' | tr '/' '-')
        TRIVY_REPORT="/tmp/trivy-report-${SERVICE_NAME_SAFE}.json"
        IMAGE="${{ inputs.image-name }}"
        TRIVY_IMAGE="${{ inputs.trivy-image }}"

        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ðŸ” Trivy Security Scan"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Image:       $IMAGE"
        echo "Service:     ${{ inputs.service-name }}"
        echo "Severity:    ${{ inputs.severity }}"
        echo "Trivy image: $TRIVY_IMAGE"
        echo ""

        rm -f "$TRIVY_REPORT"

        echo "Generating JSON vulnerability report..."
        docker run --rm \
          -v /var/run/docker.sock:/var/run/docker.sock \
          "$TRIVY_IMAGE" image \
          --format json \
          --ignore-unfixed \
          --severity "${{ inputs.severity }}" \
          --cache-dir /root/.cache/trivy \
          "$IMAGE" 2>/dev/null | jq '.' > "$TRIVY_REPORT" 2>/dev/null || true

        CRITICAL_COUNT=0
        HIGH_COUNT=0
        MEDIUM_COUNT=0

        if [ -s "$TRIVY_REPORT" ]; then
          echo "âœ… JSON report generated"
          CRITICAL_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' "$TRIVY_REPORT" 2>/dev/null || echo "0")
          HIGH_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' "$TRIVY_REPORT" 2>/dev/null || echo "0")
          MEDIUM_COUNT=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "MEDIUM")] | length' "$TRIVY_REPORT" 2>/dev/null || echo "0")

          echo "ðŸ“Š Vulnerability Summary:"
          echo "  CRITICAL: $CRITICAL_COUNT"
          echo "  HIGH:     $HIGH_COUNT"
          echo "  MEDIUM:   $MEDIUM_COUNT"
        else
          echo "Trivy JSON report was not created or is empty"
          echo '{"Results": []}' > "$TRIVY_REPORT"
        fi

        echo "Detailed Scan Results (CRITICAL & HIGH only):"
        docker run --rm \
          -v /var/run/docker.sock:/var/run/docker.sock \
          "$TRIVY_IMAGE" image \
          --format table \
          --exit-code 0 \
          --ignore-unfixed \
          --severity CRITICAL,HIGH \
          --cache-dir /root/.cache/trivy \
          "$IMAGE"

        echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
        echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT

        if [ "${{ inputs.fail-on-critical }}" = "true" ] && [ "${CRITICAL_COUNT:-0}" -gt 0 ]; then
          echo "::error::Pipeline failed: $CRITICAL_COUNT CRITICAL vulnerabilities found in $IMAGE"
          exit 1
        fi

    - name: Upload Trivy Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: trivy-report-${{ inputs.service-name }}
        path: /tmp/trivy-report-*.json
        if-no-files-found: warn
